---
title: "Did you say eclipse?"
author: "@awhstin"
date: 2017-08-07T18:13:14-05:00
categories: ["R",", ","maps"]
titleimg: "solar-1"
imgtype: "svg"
---
I am not sure if you have heard about it yet but there will be a solar eclipse on 8/21/17. If you are one of a very few people who this is news to, congrats! As the day nears there have been a lot of articles and posts on the subject, with more than a few really awesome visualizations. The unique part about the eclipse is its [path of totality](http://www.eclipse2017.org/2017/in_the_path.htm) that cuts through the [heart](https://www.youtube.com/results?search_query=total+eclipse+of+the+heart) of the United States. As you can imagine a lot of ArcGIS or javascript interactive maps exist but how creative can you really get with this somewhat limited data? 
<center>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">&quot;There are no more eclipse maps to make&quot;<br><br>Challenge accepted. <a href="https://t.co/PnFJSXeSiY">pic.twitter.com/PnFJSXeSiY</a></p>&mdash; Joshua Stevens (@jscarto) <a href="https://twitter.com/jscarto/status/892933635761995780">August 3, 2017</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
</center>
Well put. There are a lot of iterations of similar data, but I wanted to take some time to chronicle some examples I really enjoy, and make one with R for myself. The first example is, of course, from FiveThirtyEight. Their article [Two Minutes of Darkness with 20,000 Strangers](https://fivethirtyeight.com/features/eclipse-towns-planning/) is all about logistics. First is a striking map of traffic bottlenecks followed by a narrative that is supported by a table describing potential toilets needed for crowds in places. Interesting take.

The second is actually Google. More specifically Google Trends search data for the [eclipse](https://trends.google.com/trends/story/US_cu_YdGNpF0BAACx9M_en). It was pointed out via many posts (I am not sure which one was the first) that you can actually see the path of the eclipse via search trends. This is interesting to me because maybe it is because of more word-of-mouth mentions of the eclipse drives searching, or most people are informed on the actual path of it. Either way the data is interesting, especially when it is presented in such a striking way.

<iframe width='100%' height='520' frameborder='0' src='https://googledataorg.carto.com/u/googledata/viz/51003fc8-28bc-4ac8-9d30-3c430a19b0c1/embed_map' allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen></iframe>

Well let's make a version in R. (Sort of)
<hr>
##data & cleaning
We need a couple datasets, and more than a few packages in R. The data is listed below

+ [Trend Data]() via Google Trends
+ [U.S. cities](http://simplemaps.com/data/us-cities) via SimpleMaps
+ [Path of the eclipse](https://svs.gsfc.nasa.gov/4518) via NASA's Scientific Visualization Studio 

These can also be found [here](https://github.com/awhstin/solareclipse) in a special Github repo for this post.

```{r, include=FALSE}
library(extrafont)
```
```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(fuzzyjoin)
library(hrbrthemes)
library(raster)

#trend data
gtrends<- read_csv("~/Desktop/solar/geoMap (3).csv", skip = 2)

#cities
us_cities <- read_csv("~/Desktop/solar/uscitiesv1.3.csv")
us_cities$name<-paste(us_cities$city,us_cities$state_id)

#shapefile
path.m<-shapefile("~/Desktop/solar/center17.shp")
path.points<-fortify(path.m)
```

If you start to inspect the trend data you'll see it is by metro area. Instead of plotting it in that form I decided I wanted to match the cities in the metro area, and plot those by the search value. To do this we can use <code>strsplit</code>, but first we have to do a little arranging with <code>dplyr::row_number</code> to make sure the data is matched correctly. 

```{r, message=FALSE, warning=FALSE}
#clean
gtrends$state<-substr(gtrends$DMA,nchar(gtrends$DMA)-1,nchar(gtrends$DMA))
gtrends<-gtrends%>%
  arrange(-row_number())%>% #so it all works together
  mutate(DMA=strsplit(as.character(DMA),'-'))%>%
  unnest(DMA)
names(gtrends)[1]<-'count'
```

Lastly, because some of the metro areas end with the state, we need to add the state abbreviation to the rest of them. Then using the handy <code>fuzzyjoin::stringdist_left_join</code> to aid us in matching some of those pesky counties that occur in other states and other problems. This is where we take a sharp left off of the paved road onto the beaten path of inaccuracy. There are more than a few errors but at 10:45pm at night I can live with them.  
```{r, message=FALSE, warning=FALSE}
#add state
gtrends$name<-ifelse(substr(gtrends$DMA,nchar(gtrends$DMA)-1,nchar(gtrends$DMA))==gtrends$state,gtrends$DMA,paste(gtrends$DMA,gtrends$state))

#first go
first<-stringdist_left_join(gtrends,us_cities,by=c('name'),distance_col='dist')
trends<-subset(first,dist<=0 & state == state_id)
```
<hr>
##plot

Now we get to the fun part. I wanted to combine the center path line and color from the FiveThirtyEight article with the minimalist gradient scale of the Google Trends map. I remember using a U.S. county outline for a previous map and thought that offered a nice low-impact background to build on. Then it was just a matter of plotting the data we have matching so far. 

```{r, message=FALSE, warning=FALSE,fig.height=6.75,fig.width=10.25}
labels<-subset(trends,count >=83) #for the labels

#plot
us<-map_data('county')
solar<-ggplot(trends,aes(lng,lat)) +
  geom_polygon(data=us,aes(x=long,y=lat,group=group),color='#dedede',fill=NA,alpha=.45,cex=.35,show.legend = F)+
  geom_point(aes(color=count,size=count),alpha=.55,show.legend = F) +
  geom_line(data=path.points,aes(x=long,y=lat),color='#c52828',size=4,alpha=.25,show.legend = F)+
  geom_line(data=path.points,aes(x=long,y=lat),color='#c52828',size=1,alpha=.75,show.legend = F)+
  scale_colour_gradient(low = "white", high = "#444444")+
  theme_ipsum(grid=F,plot_title_family = 'Slabo 27px',plot_title_face = 'bold',subtitle_size = 10,base_family = 'Roboto Condensed')+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
  xlim(-135,-65)+ylim(20,50)

solar+
  labs(title='Google Trends for \'Solar Eclipse\'',
           subtitle='Data for time period between 7/25/17 & 8/1/2017',
           caption='Search data from Google Trends\nSolar Eclipse Path Shapefile from NASA')+
  geom_text(data=labels,aes(label=name.x,size=14),family='Roboto Condensed' ,show.legend = F,check_overlap = T)
```
<center>
```{r solar, fig.path='../', message=FALSE, warning=FALSE, dev='svg', include=FALSE,fig.height=6.5,fig.width=10.25}
solar<-ggplot(trends,aes(lng,lat)) +
  geom_polygon(data=us,aes(x=long,y=lat,group=group),color='#dedede',fill=NA,alpha=.45,cex=.35,show.legend = F)+
  geom_point(aes(color=count,size=count),alpha=.55,show.legend = F) +
  geom_line(data=path.points,aes(x=long,y=lat),color='#c52828',size=4,alpha=.25,show.legend = F)+
  geom_line(data=path.points,aes(x=long,y=lat),color='#c52828',size=1,alpha=.75,show.legend = F)+
  scale_colour_gradient(low = "white", high = "#444444")+
  theme_ipsum(grid=F,plot_title_family = 'Slabo 27px',plot_title_face = 'bold',subtitle_size = 10,base_family = 'Roboto Condensed')+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
  xlim(-135,-65)+ylim(20,50)

solar+
  labs(title='Google Trends for \'Solar Eclipse\'',
           subtitle='Data for time period between 7/25/17 & 8/1/2017',
           caption='Search data from Google Trends\nSolar Eclipse Path Shapefile from NASA')+
  geom_text(data=labels,aes(label=name.x,size=14),family='Roboto Condensed' ,show.legend = F,check_overlap = T)
```
</center>

If you aren't happy with this, or have other ideas I would love to see other interpretations of this data with R, or even improvements to this if you want.
